name: Autolabel PRs

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened]
  push:
    paths:
      - scripts/autolabel.lean
      - .github/workflows/add_label_from_diff.yaml

jobs:
  add_topic_label:
    name: Add topic label
    runs-on: ubuntu-latest
    # Don't run on forks, where we wouldn't have permissions to add the label anyway.
    #if: github.repository == 'leanprover-community/mathlib4'
    permissions:
      issues: write
      checks: write
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: install elan
        run: |
          set -o pipefail
          curl -sSfL https://github.com/leanprover/elan/releases/download/v3.1.1/elan-x86_64-unknown-linux-gnu.tar.gz | tar xz
          ./elan-init -y --default-toolchain none
          echo "$HOME/.elan/bin" >> "${GITHUB_PATH}"
      - name: lake exe autolabel
        run: |
          # the checkout dance, to avoid a detached head
          printf 'git checkout master\n'
          git checkout master
          printf 'git checkout -\n'
          git checkout -
          printf 'git diff --name-only origin/master...HEAD\n'
          git diff --name-only origin/master...HEAD
          printf 'lake exe autolabel %s\n' "$NUMBER"
          lake exe autolabel "$NUMBER"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.number }}
